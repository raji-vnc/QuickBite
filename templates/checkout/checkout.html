<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Checkout - QuickBite</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Razorpay Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>

<body class="bg-gray-50">

<div class="max-w-4xl mx-auto mt-10">

    <h1 class="text-3xl font-bold mb-6">Checkout</h1>

    <div class="grid grid-cols-2 gap-8">

        <!-- LEFT SIDE — ADDRESS -->
        <div class="bg-white shadow p-5 rounded-xl">
            <h2 class="text-xl font-semibold mb-3">Delivery Address</h2>

            <form method="POST">
                {% csrf_token %}
                <textarea name="address" rows="5" class="w-full p-3 border rounded-xl"
                          placeholder="Enter your delivery address..." required></textarea>

                <button type="submit"
                        class="mt-4 bg-gray-800 text-white px-5 py-2 rounded-xl hover:bg-black">
                    Save Address
                </button>
            </form>
        </div>

        <!-- RIGHT SIDE — ORDER SUMMARY -->
        <div class="bg-white shadow p-5 rounded-xl">

            <h2 class="text-xl font-semibold mb-4">Order Summary</h2>

            <div>
                {% for item in cart_items %}
                <div class="flex justify-between py-2 border-b">
                    <p>{{ item.item.name }} × {{ item.quantity }}</p>
                    <p>₹{{ item.total_price }}</p>
                </div>
                {% endfor %}
            </div>

            <div class="flex justify-between mt-4 text-lg font-bold">
                <p>Total</p>
                <p>₹{{ total }}</p>
            </div>

            <!-- PAYMENT BUTTON -->
            <button onclick="payNow()" 
                    class="w-full mt-5 bg-red-500 text-white py-3 rounded-xl text-lg font-semibold hover:bg-red-600">
                Pay & Place Order
            </button>

        </div>

    </div>
</div>


<script>
function payNow() {
    var options = {
        "key": "{{ razorpay_key }}",
        "amount": "{{ total_in_paise }}",
        "currency": "INR",
        "name": "QuickBite",
        "description": "Food Order Payment",
        "order_id": "{{ razorpay_order_id }}",

        "handler": function (response) {
            fetch("/api/payment/success/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    payment_id: response.razorpay_payment_id,
                    order_id: response.razorpay_order_id,
                    quickbite_order_id: "{{ quickbite_order_id }}"
                })
            })
            .then(res => res.json())
            .then(data => {
                window.location.href = "/order/success/";
            });
        },

        "theme": {
            "color": "#EF4444"
        }
    };
    var rzp1 = new Razorpay(options);
    rzp1.open();
}
</script>


<div class="bg-white p-4 rounded-xl shadow mt-4">

    <h3 class="text-lg font-bold mb-3">Have a Coupon?</h3>

    <div class="flex gap-3">
        <input id="coupon_code" type="text" placeholder="Enter coupon"
               class="border p-3 rounded-xl flex-1">
        
        <button onclick="applyCoupon()"
                class="bg-green-500 text-white px-4 py-3 rounded-xl">
            Apply
        </button>
    </div>

    <p id="coupon_msg" class="mt-3 text-sm"></p>
</div>

<script>
function applyCoupon() {
    const code = document.getElementById("coupon_code").value;
    const totalAmount = total    // existing total from backend

    fetch("/apply-coupon/", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: `coupon_code=${code}&total_amount=${totalAmount}`
    })
    .then(res => res.json())
    .then(data => {
        const msg = document.getElementById("coupon_msg");

        if (data.success) {
            msg.innerHTML = `<span class='text-green-600'>Discount Applied: ₹${data.discount}</span>`;

            document.getElementById("final_total").innerText = data.final_amount;
        } else {
            msg.innerHTML = `<span class='text-red-600'>${data.message}</span>`;
        }
    });
}
</script>
<p class="text-xl font-bold">Final Total: ₹<span id="final_total">{{ total }}</span></p>

</body>
</html>
